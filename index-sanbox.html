<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Green Insurance - Quote Survey</title>

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body.green-quote-modal-active {
      overflow: hidden;
    }

    body {
      font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top left, #1e3a3a 0, #030712 40%, #000 100%);
      color: #fff;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(22, 163, 74, 0.25) 0, rgba(0, 0, 0, 0.9) 45%, #000 100%);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      overflow: hidden;
    }

    /* Animated Background */
    .floating-particles {
      position: absolute;
      width: 130%;
      height: 130%;
      top: -15%;
      left: -15%;
      overflow: hidden;
      pointer-events: none;
      filter: blur(2px);
    }

    .particle {
      position: absolute;
      background: radial-gradient(circle, rgba(74, 222, 128, 0.3) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      animation: float-up 18s infinite;
      mix-blend-mode: screen;
    }

    @keyframes float-up {
      0% {
        transform: translateY(105vh) scale(0.2);
        opacity: 0;
      }
      10% {
        opacity: 0.6;
      }
      90% {
        opacity: 0.5;
      }
      100% {
        transform: translateY(-105vh) scale(1.8);
        opacity: 0;
      }
    }

    /* Glass card */
    .modal-container {
      position: relative;
      background: radial-gradient(circle at top left, #020617 0%, #020617 40%, #020617 100%);
      border-radius: 26px;
      border: 1px solid rgba(52, 211, 153, 0.35);
      box-shadow:
        0 18px 80px rgba(0, 0, 0, 0.9),
        0 0 70px rgba(34, 197, 94, 0.5);
      max-width: 720px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUpQuote 0.35s ease;
      color: #fff;
      backdrop-filter: blur(24px);
    }

    @keyframes slideUpQuote {
      from { opacity: 0; transform: translateY(30px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .modal-header {
      padding: 26px 34px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      position: relative;
    }

    .modal-title {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .modal-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: rgba(226, 232, 240, 0.78);
    }

    .modal-body {
      padding: 22px 34px 26px;
    }

    /* Close button */
    .close-button {
      position: absolute;
      top: 18px;
      right: 20px;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .close-button:hover {
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.15), rgba(15, 23, 42, 0.95));
      transform: rotate(90deg) scale(1.02);
      box-shadow: 0 0 18px rgba(74, 222, 128, 0.55);
    }

    /* Progress */
    .progress-container {
      margin-bottom: 18px;
    }

    .progress-bar {
      height: 6px;
      background: radial-gradient(circle at top, #020617, #020617);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.7);
    }

    .progress-fill {
      height: 100%;
      width: 25%;
      background: linear-gradient(90deg, #22c55e, #4ade80, #22c55e);
      border-radius: 999px;
      transition: width 0.25s ease;
      box-shadow: 0 0 16px rgba(34, 197, 94, 0.9);
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .step-dot {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #020617, #020617);
      border: 1px solid rgba(148, 163, 184, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: #9ca3af;
      transition: all 0.2s ease;
    }

    .step-dot.active {
      background: radial-gradient(circle at top left, #22c55e, #16a34a);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 0 16px rgba(34, 197, 94, 0.9);
      transform: translateY(-1px);
    }

    .step-dot.completed {
      background: radial-gradient(circle at top left, #0f766e, #22c55e);
      color: #fff;
    }

    /* Steps */
    .form-step {
      display: none;
    }

    .form-step.active {
      display: block;
      animation: fadeInStep 0.22s ease;
    }

    @keyframes fadeInStep {
      from { opacity: 0; transform: translateX(16px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    .form-group {
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 5px;
      color: rgba(226, 232, 240, 0.9);
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 11px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
      transition: all 0.18s ease;
      font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(148, 163, 184, 0.85);
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #22c55e;
      box-shadow:
        0 0 0 1px rgba(34, 197, 94, 0.45),
        0 0 18px rgba(34, 197, 94, 0.7);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.98));
    }

    select option {
      background: #020617;
      color: #f9fafb;
    }

    .error {
      border-color: #f97373 !important;
      box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.6);
    }

    .error-message {
      font-size: 11px;
      color: #fecaca;
      margin-top: 3px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .form-navigation {
      display: flex !important;
      justify-content: space-between;
      gap: 12px;
      margin-top: 22px;
    }

    .nav-button {
      flex: 1;
      padding: 11px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.22s ease;
      font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .back-button {
      background: radial-gradient(circle at top left, #020617, #020617);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.7);
      max-width: 132px;
    }

    .back-button:hover {
      background: radial-gradient(circle at top left, #020617, #020617);
      box-shadow: 0 0 16px rgba(148, 163, 184, 0.6);
      transform: translateY(-1px);
    }

    .next-button,
    .submit-button {
      background: radial-gradient(circle at top left, #22c55e, #16a34a);
      color: #f9fafb;
      box-shadow:
        0 12px 35px rgba(22, 163, 74, 0.9),
        0 0 24px rgba(22, 163, 74, 0.9);
      border: none;
    }

    .next-button:hover,
    .submit-button:hover {
      transform: translateY(-1px) scale(1.01);
      box-shadow:
        0 18px 40px rgba(22, 163, 74, 1),
        0 0 28px rgba(22, 163, 74, 1);
    }

    .summary-section {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border-radius: 14px;
      padding: 14px 16px;
      margin-top: 10px;
      border: 1px solid rgba(51, 65, 85, 0.9);
    }

    .summary-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(51, 65, 85, 0.9);
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: #9ca3af;
    }

    .summary-value {
      font-weight: 600;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 26px;
      right: 26px;
      padding: 16px 24px;
      background: radial-gradient(circle at top left, #020617, #020617);
      border-radius: 999px;
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 1),
        0 0 24px rgba(22, 163, 74, 0.8);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.25s ease;
      z-index: 20000;
      color: #e5e7eb;
      font-size: 13px;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    @keyframes slideIn {
      from {
        transform: translateX(110%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #22c55e;
    }

    .toast.error {
      border-left: 4px solid #f97373;
    }

    /* Simple Two-Button Design */
    .button-group.horizontal {
      display: flex;
      gap: 14px;
      margin: 22px 0 8px;
      justify-content: center;
    }

    .simple-button {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 13px 20px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .primary-green {
      background: radial-gradient(circle at top left, #22c55e, #16a34a);
      color: white;
      box-shadow: 0 10px 26px rgba(22, 163, 74, 0.8);
    }

    .primary-green:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 36px rgba(22, 163, 74, 1);
    }

    .outline-green {
      background: radial-gradient(circle at top left, #020617, #020617);
      color: #4ade80;
      border: 1px solid rgba(74, 222, 128, 0.7);
      box-shadow: 0 0 16px rgba(34, 197, 94, 0.5);
    }

    .outline-green:hover {
      background: radial-gradient(circle at top left, rgba(22, 163, 74, 0.18), #020617);
      transform: translateY(-1px);
    }

    .button-icon {
      font-size: 17px;
    }

    /* Language Selection Buttons (smaller) */
    .language-buttons {
      display: flex;
      gap: 14px;
      justify-content: center;
      margin: 26px 0 6px;
    }

    .language-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 14px 18px;
      background: radial-gradient(circle at top left, rgba(22, 163, 74, 0.12), rgba(22, 163, 74, 0.05));
      border: 1px solid rgba(74, 222, 128, 0.75);
      border-radius: 18px;
      cursor: pointer;
      transition: all 0.25s ease;
      min-width: 130px;
      max-width: 140px;
      box-shadow: 0 10px 24px rgba(34, 197, 94, 0.3);
    }

    .language-button:hover {
      background: radial-gradient(circle at top left, rgba(22, 163, 74, 0.28), rgba(22, 163, 74, 0.12));
      transform: translateY(-2px);
      box-shadow: 0 18px 36px rgba(34, 197, 94, 0.55);
    }

    .flag-icon {
      font-size: 32px;
      line-height: 1;
    }

    .language-text {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }

    /* Phone Search Section */
    .phone-search-info {
      text-align: center;
      margin-bottom: 16px;
      color: rgba(226, 232, 240, 0.85);
      font-size: 13px;
    }

    .phone-search-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .phone-search-row input {
      flex: 1;
    }

    .search-button {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      background: radial-gradient(circle at top left, #22c55e, #16a34a);
      color: #f9fafb;
      box-shadow: 0 12px 30px rgba(22, 163, 74, 0.9);
      transition: all 0.2s ease;
      font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      white-space: nowrap;
    }

    .search-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(22, 163, 74, 1);
    }

    @media (max-width: 640px) {
      .modal-container {
        margin: 16px;
        max-height: 84vh;
      }
      .modal-header {
        padding: 22px 20px 10px;
      }
      .modal-body {
        padding: 18px 20px 22px;
      }
      .modal-title {
        font-size: 22px;
      }
      .form-navigation {
        flex-direction: column-reverse;
      }
      .back-button {
        max-width: none;
      }
      .language-buttons {
        flex-direction: column;
      }
      .language-button {
        width: 100%;
        max-width: none;
      }
      .phone-search-row {
        flex-direction: column;
        align-items: stretch;
      }
      .search-button {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <!-- MODAL HTML -->
  <div id="modalOverlay" class="modal-overlay">
    <!-- Animated Background Particles -->
    <div class="floating-particles" id="particles"></div>

    <div class="modal-container">
      <button class="close-button" onclick="resetToMainMenu()">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
          <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <div class="modal-header">
        <h1 class="modal-title">Add New Opportunity</h1>
        <p class="modal-subtitle" id="headerSubtitle">Choose how you would like to proceed</p>
      </div>

      <div class="modal-body">
        <!-- Initial choice buttons -->
        <div id="initialChoice" class="button-group horizontal">
          <button class="simple-button primary-green" onclick="startNewContact()">
            <span class="button-icon">+</span>
            <span class="button-text">New Opportunity</span>
          </button>
          <button class="simple-button outline-green" onclick="startExistingContact()">
            <span class="button-icon">ðŸ‘¥</span>
            <span class="button-text">Existing Opportunity</span>
          </button>
        </div>

        <!-- Language Selection (shown after choosing new) -->
        <div id="languageSelection" style="display: none;">
          <div class="language-buttons">
            <button class="language-button" onclick="selectLanguage('English')">
              <span class="flag-icon">ðŸ‡ºðŸ‡¸</span>
              <span class="language-text">English</span>
            </button>
            <button class="language-button" onclick="selectLanguage('Spanish')">
              <span class="flag-icon">ðŸ‡ªðŸ‡¸</span>
              <span class="language-text">EspaÃ±ol</span>
            </button>
          </div>
        </div>

        <!-- Phone Search for Existing Contacts -->
        <div id="contactSelection" style="display: none;">
          <div class="phone-search-info">
            Enter the phone number of the existing contact to link this quote
          </div>
          <div class="form-group">
            <label for="contactPhoneSearch">Phone Number *</label>
            <div class="phone-search-row">
              <input type="tel" id="contactPhoneSearch" placeholder="(555) 123-4567" required>
              <button class="search-button" onclick="handleExistingSearch()">Search</button>
            </div>
            <div class="error-message">Please enter a valid phone number</div>
          </div>
          <div class="form-navigation">
            <button class="nav-button back-button" onclick="backToChoice()">Back</button>
          </div>
        </div>

        <!-- Multi step form -->
        <div id="quoteForm" style="display:none;">
          <div class="progress-container">
            <div class="progress-bar">
              <div id="progressFill" class="progress-fill"></div>
            </div>
            <div class="step-indicator" id="stepIndicator"></div>
          </div>

          <!-- STEP 0: CONTACT INFO (for new contacts or confirmed existing) -->
          <div id="step0" class="form-step">
            <div class="form-group">
              <label for="contactFirstName">First Name *</label>
              <input type="text" id="contactFirstName" placeholder="Enter first name" required>
              <div class="error-message">First name is required</div>
            </div>
            <div class="form-group">
              <label for="contactLastName">Last Name *</label>
              <input type="text" id="contactLastName" placeholder="Enter last name" required>
              <div class="error-message">Last name is required</div>
            </div>
            <div class="form-group">
              <label for="contactEmail">Email *</label>
              <input type="email" id="contactEmail" placeholder="Enter email address" required>
              <div class="error-message">Valid email is required</div>
            </div>
            <div class="form-group">
              <label for="contactPhone">Phone *</label>
              <input type="tel" id="contactPhone" placeholder="Enter phone number" required>
              <div class="error-message">Phone number is required</div>
            </div>
          </div>

          <!-- STEP 1: BASIC INFO -->
          <div id="step1" class="form-step">
            <div class="form-group">
              <label for="quoteNumber">Quote Number *</label>
              <input id="quoteNumber" type="text" placeholder="Auto-generated" readonly>
            </div>

            <div class="form-group">
              <label for="quoteStatus">Quote Status *</label>
              <select id="quoteStatus" required>
                <option value="">Please select</option>
                <option value="New" selected>New</option>
                <option value="In Progress">In Progress</option>
                <option value="Quoted">Quoted</option>
                <option value="Sent to Client">Sent to Client</option>
                <option value="Accepted">Accepted</option>
                <option value="Rejected">Rejected</option>
                <option value="Lost to Competitor">Lost to Competitor</option>
              </select>
              <div class="error-message">Please select a status</div>
            </div>

            <div class="form-group">
              <label for="lineOfBusiness">Line of Business *</label>
              <select id="lineOfBusiness" required>
                <option value="">Please select</option>
                <option value="Personal Auto">Personal Auto</option>
                <option value="Commercial Auto">Commercial Auto</option>
                <option value="Health">Health</option>
                <option value="Life">Life</option>
                <option value="Dental">Dental</option>
                <option value="Workers Comp">Workers Comp</option>
                <option value="General Liability">General Liability</option>
              </select>
              <div class="error-message">Please select a line of business</div>
            </div>
          </div>

          <!-- STEP 2: CARRIER INFO -->
          <div id="step2" class="form-step">
            <div class="form-group">
              <label for="ezlynxQuoteId">EZLynx Quote ID</label>
              <input id="ezlynxQuoteId" type="text" placeholder="Enter EZLynx ID (optional)">
            </div>

            <div class="form-group">
              <label for="mainCarrier">Main Carrier *</label>
              <select id="mainCarrier" required>
                <option value="">Please select</option>
                <option>Advantage</option>
                <option>Allstate</option>
                <option>Amtrust</option>
                <option>Appalachian Underwriters</option>
                <option>Assurant</option>
                <option>Assurance Renters</option>
                <option>Attune</option>
                <option>Auto-Owners</option>
                <option>Bass Underwriters</option>
                <option>Benchmark Insurance</option>
                <option>Berkley Net</option>
                <option>Berkshire Hathaway Direct</option>
                <option>Biberk</option>
                <option>Bristol West</option>
                <option>Capitol Indemnity</option>
                <option>Cimarron</option>
                <option>Clear Blue Insurance</option>
                <option>Coterie</option>
                <option>Crum & Forster</option>
                <option>Employers</option>
                <option>Evanston Insurance Company</option>
                <option>First Connect</option>
                <option>Foremost</option>
                <option>Frankcrum Insurance</option>
                <option>Gainsco</option>
                <option>Geico</option>
                <option>Hanover</option>
                <option>Hiscox</option>
                <option>Home Insurance</option>
                <option>Infinity</option>
                <option>Liberty Mutual</option>
                <option>Nautilus</option>
                <option>Next</option>
                <option>Pathpoint</option>
                <option>Progressive</option>
                <option>RLI</option>
                <option>Southbay</option>
                <option>Spinnaker Insurance</option>
                <option>Suprem</option>
                <option>Technology Insurance Company</option>
                <option>Travelers</option>
                <option>USLI</option>
                <option>Verve</option>
                <option>Western World Insurance</option>
                <option>Workers Comp</option>
              </select>
              <div class="error-message">Carrier is required</div>
            </div>

            <div class="form-group">
              <label for="effectiveDate">Effective Date *</label>
              <input id="effectiveDate" type="date" required>
              <div class="error-message">Effective date is required</div>
            </div>
          </div>

          <!-- STEP 3: PREMIUM / FINANCIALS -->
          <div id="step3" class="form-step">
            <div class="form-group">
              <label for="grossPremium">Gross Premium *</label>
              <input id="grossPremium" type="text" placeholder="$0.00" required>
              <div class="error-message">Gross premium is required</div>
            </div>

            <div class="form-group">
              <label for="taxesAndFees">Taxes and Fees</label>
              <input id="taxesAndFees" type="text" placeholder="$0.00">
            </div>

            <div class="form-group">
              <label for="agencyFees">Agency Fees</label>
              <input id="agencyFees" type="text" placeholder="$0.00">
            </div>

            <div class="form-group">
              <label for="totalPremium">Total Premium *</label>
              <input id="totalPremium" type="text" placeholder="$0.00" readonly>
              <div class="error-message">Total premium is required</div>
            </div>

            <div class="form-group">
              <label for="paymentPlan">Payment Plan *</label>
              <select id="paymentPlan" required onchange="handlePaymentPlanChange()">
                <option value="">Please select</option>
                <option>Paid in Full</option>
                <option>Monthly</option>
                <option>Two Payments</option>
                <option>Other</option>
              </select>
              <div class="error-message">Payment plan is required</div>
            </div>

            <div class="form-group">
              <label for="downPayment">Down Payment</label>
              <input id="downPayment" type="text" placeholder="$0.00">
              <div class="error-message">Down payment is required for monthly plans</div>
            </div>

            <div class="form-group">
              <label for="monthlyPremium">Monthly Premium</label>
              <input id="monthlyPremium" type="text" placeholder="$0.00">
              <div class="error-message">Monthly premium is required for monthly plans</div>
            </div>

            <div class="form-group">
              <label for="location">Location *</label>
              <select id="location" required>
                <option value="">Please select</option>
                <option>Roswell</option>
                <option>Marietta</option>
                <option>Atlanta</option>
                <option>Morrow</option>
                <option>Jonesboro</option>
              </select>
              <div class="error-message">Location is required</div>
            </div>
          </div>

          <!-- STEP 4: DATES + REVIEW -->
          <div id="step4" class="form-step">
            <div class="form-group">
              <label for="dateQuoted">Date Quoted *</label>
              <input id="dateQuoted" type="date" required>
              <div class="error-message">Date quoted is required</div>
            </div>

            <div class="form-group">
              <label for="expirationDate">Expiration Date *</label>
              <input id="expirationDate" type="date" required>
              <div class="error-message">Expiration date is required</div>
            </div>

            <div class="form-group">
              <label for="notes">Additional Notes</label>
              <textarea id="notes" rows="3" placeholder="Enter any additional notes"></textarea>
            </div>

            <div class="summary-section">
              <h3 class="summary-title">Quote Summary</h3>
              <div class="summary-item">
                <span class="summary-label">Quote Number</span>
                <span id="summaryQuoteNumber" class="summary-value">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Status</span>
                <span id="summaryStatus" class="summary-value">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Line of Business</span>
                <span id="summaryLOB" class="summary-value">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Carrier</span>
                <span id="summaryCarrier" class="summary-value">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Total Premium</span>
                <span id="summaryPremium" class="summary-value">-</span>
              </div>
            </div>
          </div>

          <!-- NAV BUTTONS -->
          <div class="form-navigation">
            <button id="backBtn" class="nav-button back-button" onclick="previousStep()" style="display:none;">Back</button>
            <button id="nextBtn" class="nav-button next-button" onclick="nextStep()">Next</button>
            <button id="submitBtn" class="nav-button submit-button" onclick="submitForm()" style="display:none;">Submit Quote</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ðŸ”‘ GHL API config
    const API_KEY = "pit-609ea3a9-5374-48c4-b835-74daf043d5e8";
    const LOCATION_ID = "YtNhoKQqqoEZSVFceqZm";

    let currentStep = 1;
    let totalSteps = 4;
    let isNewContact = false;
    let selectedContactId = null;
    let selectedLanguage = null;
    let existingContactPhone = null;

    // Generate unique quote number
    function generateQuoteNumber() {
      const date = new Date();
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      return `Q${year}${month}${day}-${random}`;
    }

    // Create animated background particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      if (!particlesContainer) return;
      const particleCount = 18;

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';

        const size = Math.random() * 70 + 40;
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';

        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 18 + 's';
        particle.style.animationDuration = (Math.random() * 12 + 18) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    // Show modal when page loads
    window.addEventListener('load', () => {
      const overlay = document.getElementById('modalOverlay');
      if (!overlay) return;
      overlay.style.display = 'flex';
      document.body.classList.add('green-quote-modal-active');

      createParticles();

      const today = new Date().toISOString().split('T')[0];
      const dq = document.getElementById('dateQuoted');
      if (dq) dq.value = today;
      const qn = document.getElementById('quoteNumber');
      if (qn) qn.value = generateQuoteNumber();
    });

    function closeModal() {
      const overlay = document.getElementById('modalOverlay');
      if (!overlay) return;
      overlay.style.display = 'none';
      document.body.classList.remove('green-quote-modal-active');
    }

    function resetToMainMenu() {
      document.getElementById('contactSelection').style.display = 'none';
      document.getElementById('languageSelection').style.display = 'none';
      document.getElementById('quoteForm').style.display = 'none';

      const initialChoice = document.getElementById('initialChoice');
      initialChoice.style.display = 'flex';
      initialChoice.className = 'button-group horizontal';

      document.getElementById('headerSubtitle').textContent = 'Choose how you would like to proceed';

      currentStep = 1;
      totalSteps = 4;
      isNewContact = false;
      selectedContactId = null;
      selectedLanguage = null;
      existingContactPhone = null;

      document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
    }

    function startNewContact() {
      isNewContact = true;
      selectedContactId = null;

      document.getElementById('initialChoice').style.display = 'none';
      document.getElementById('languageSelection').style.display = 'block';
      document.getElementById('headerSubtitle').textContent = 'Select your preferred language';
    }

    function selectLanguage(language) {
      selectedLanguage = language;
      totalSteps = 5;
      currentStep = 0;

      document.getElementById('languageSelection').style.display = 'none';
      document.getElementById('quoteForm').style.display = 'block';

      setupStepIndicators();
      document.getElementById('step0').classList.add('active');
      updateProgress();
      updateNavigation();
      document.getElementById('headerSubtitle').textContent = 'Step 1 of 5: Contact Information';
    }

    function startExistingContact() {
      isNewContact = false;
      selectedContactId = null;

      document.getElementById('initialChoice').style.display = 'none';
      document.getElementById('contactSelection').style.display = 'block';
      document.getElementById('headerSubtitle').textContent = 'Enter existing contact phone number';

      document.getElementById('contactPhoneSearch').value = '';
    }

    function backToChoice() {
      document.getElementById('contactSelection').style.display = 'none';
      const initialChoice = document.getElementById('initialChoice');
      initialChoice.style.display = 'flex';
      initialChoice.className = 'button-group horizontal';
      document.getElementById('headerSubtitle').textContent = 'Choose how you would like to proceed';
    }

    async function handleExistingSearch() {
      const phoneInput = document.getElementById('contactPhoneSearch');
      const rawPhone = phoneInput.value;
      const cleanPhone = rawPhone.replace(/\D/g, '');

      if (!rawPhone || cleanPhone.length < 7) {
        phoneInput.classList.add('error');
        phoneInput.parentElement.parentElement.querySelector('.error-message').classList.add('show');
        return;
      }

      phoneInput.classList.remove('error');
      phoneInput.parentElement.parentElement.querySelector('.error-message').classList.remove('show');

      showToast('Searching contact...', 'success');

      const contact = await searchContactByPhone(rawPhone);
      if (!contact) return;

      // Fill step0 fields with returned data
      document.getElementById('contactFirstName').value = contact.firstName || '';
      document.getElementById('contactLastName').value = contact.lastName || '';
      document.getElementById('contactEmail').value = contact.email || '';
      document.getElementById('contactPhone').value = (contact.phone && contact.phone.mobile) || cleanPhone;

      selectedContactId = contact.id;
      existingContactPhone = (contact.phone && contact.phone.mobile) || cleanPhone;

      showToast('Contact found. Please confirm details and continue.', 'success');

      totalSteps = 5; // still 5 steps, but step0 is confirmation
      currentStep = 0;

      document.getElementById('contactSelection').style.display = 'none';
      document.getElementById('quoteForm').style.display = 'block';

      setupStepIndicators();
      document.getElementById('step0').classList.add('active');
      updateProgress();
      updateNavigation();
      document.getElementById('headerSubtitle').textContent = 'Step 1 of 5: Confirm Contact Information';
    }

    async function searchContactByPhone(phoneRaw) {
      const phone = phoneRaw.replace(/\D/g, '');

      if (!phone || phone.length < 7) {
        showToast("Please enter a valid phone number", "error");
        return null;
      }

      try {
        const url = `https://services.leadconnectorhq.com/contacts/search?locationId=${LOCATION_ID}&query=${encodeURIComponent(phone)}`;

        const response = await fetch(url, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${API_KEY}`,
            "Version": "2021-07-28",
            "Accept": "application/json"
          }
        });

        if (!response.ok) {
          console.error("Search error:", response.status, await response.text());
          showToast("Error searching contact. Please verify your API key and location.", "error");
          return null;
        }

        const data = await response.json();
        console.log("Search result:", data);

        if (!data.contacts || data.contacts.length === 0) {
          showToast("No contact found with that phone. You can create a new contact instead.", "error");
          return null;
        }

        return data.contacts[0];
      } catch (err) {
        console.error("Network error:", err);
        showToast("Error searching contact. Please verify your API key and location.", "error");
        return null;
      }
    }

    function setupStepIndicators() {
      const indicatorContainer = document.getElementById('stepIndicator');
      indicatorContainer.innerHTML = '';

      for (let i = 1; i <= totalSteps; i++) {
        const dot = document.createElement('div');
        dot.className = 'step-dot';
        dot.id = `dot${i}`;
        dot.textContent = i;
        if (i === 1) dot.classList.add('active');
        indicatorContainer.appendChild(dot);
      }
    }

    // Currency helpers
    function formatCurrency(value) {
      const num = parseFloat(value.replace(/[^0-9.-]/g, '')) || 0;
      return '$' + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function parseCurrency(value) {
      return parseFloat(value.replace(/[^0-9.-]/g, '')) || 0;
    }

    function calculateTotal() {
      const gross = parseCurrency(document.getElementById('grossPremium').value);
      const taxes = parseCurrency(document.getElementById('taxesAndFees').value);

      const agencyField = document.getElementById('agencyFees');
      if (!agencyField.dataset.manual && gross > 0) {
        agencyField.value = formatCurrency(String(gross * 0.10));
      }

      const agency = parseCurrency(agencyField.value);
      const total = gross + taxes + agency;
      document.getElementById('totalPremium').value = formatCurrency(String(total));
    }

    ['grossPremium', 'taxesAndFees', 'agencyFees', 'downPayment', 'monthlyPremium'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('blur', function() {
          if (this.value) this.value = formatCurrency(this.value);
        });
        el.addEventListener('focus', function() {
          if (this.value) this.value = parseCurrency(this.value).toString();
        });
        if (id !== 'agencyFees') {
          el.addEventListener('input', calculateTotal);
        } else {
          el.addEventListener('input', function() {
            this.dataset.manual = 'true';
            calculateTotal();
          });
        }
      }
    });

    function handlePaymentPlanChange() {
      const plan = document.getElementById('paymentPlan').value;
      const isMonthly = plan === 'Monthly';

      const downPayment = document.getElementById('downPayment');
      const monthlyPremium = document.getElementById('monthlyPremium');

      downPayment.required = isMonthly;
      monthlyPremium.required = isMonthly;

      const downLabel = downPayment.parentElement.querySelector('label');
      const monthlyLabel = monthlyPremium.parentElement.querySelector('label');

      if (isMonthly) {
        downLabel.textContent = 'Down Payment *';
        monthlyLabel.textContent = 'Monthly Premium *';
        downPayment.parentElement.querySelector('.error-message').style.display = 'block';
        monthlyPremium.parentElement.querySelector('.error-message').style.display = 'block';
      } else {
        downLabel.textContent = 'Down Payment';
        monthlyLabel.textContent = 'Monthly Premium';
        downPayment.parentElement.querySelector('.error-message').style.display = 'none';
        monthlyPremium.parentElement.querySelector('.error-message').style.display = 'none';
      }
    }

    function nextStep() {
      if (!validateStep(currentStep)) return;
      if (currentStep >= totalSteps - 1) return;

      document.getElementById(`step${currentStep}`).classList.remove('active');
      const dotIndex = currentStep + 1;
      document.getElementById(`dot${dotIndex}`).classList.remove('active');
      document.getElementById(`dot${dotIndex}`).classList.add('completed');

      currentStep++;

      document.getElementById(`step${currentStep}`).classList.add('active');
      const nextDotIndex = currentStep + 1;
      document.getElementById(`dot${nextDotIndex}`).classList.add('active');

      updateProgress();
      updateNavigation();
      updateHeaderSubtitle();

      if (currentStep === totalSteps - 1) updateSummary();
    }

    function previousStep() {
      const minStep = 0;
      if (currentStep <= minStep) return;

      document.getElementById(`step${currentStep}`).classList.remove('active');
      const dotIndex = currentStep + 1;
      document.getElementById(`dot${dotIndex}`).classList.remove('active');

      currentStep--;

      document.getElementById(`step${currentStep}`).classList.add('active');
      const prevDotIndex = currentStep + 1;
      document.getElementById(`dot${prevDotIndex}`).classList.add('active');
      document.getElementById(`dot${prevDotIndex}`).classList.remove('completed');

      updateProgress();
      updateNavigation();
      updateHeaderSubtitle();
    }

    function updateProgress() {
      const percent = ((currentStep + 1) / totalSteps) * 100;
      document.getElementById('progressFill').style.width = percent + '%';
    }

    function updateNavigation() {
      const backBtn = document.getElementById('backBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');

      backBtn.style.display = currentStep > 0 ? 'block' : 'none';

      if (currentStep === totalSteps - 1) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'block';
      } else {
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
      }
    }

    function updateHeaderSubtitle() {
      const subtitles = [
        'Step 1 of ' + totalSteps + ': Contact Information',
        'Step 2 of ' + totalSteps + ': Basic Information',
        'Step 3 of ' + totalSteps + ': Carrier Information',
        'Step 4 of ' + totalSteps + ': Premium and Payment Details',
        'Step 5 of ' + totalSteps + ': Dates and Review'
      ];
      document.getElementById('headerSubtitle').textContent = subtitles[currentStep] || '';
    }

    function updateSummary() {
      document.getElementById('summaryQuoteNumber').textContent = document.getElementById('quoteNumber').value || '-';
      document.getElementById('summaryStatus').textContent = document.getElementById('quoteStatus').value || '-';
      document.getElementById('summaryLOB').textContent = document.getElementById('lineOfBusiness').value || '-';
      document.getElementById('summaryCarrier').textContent = document.getElementById('mainCarrier').value || '-';
      const total = document.getElementById('totalPremium').value;
      document.getElementById('summaryPremium').textContent = total || '-';
    }

    function validateStep(step) {
      let valid = true;
      const stepElement = document.getElementById(`step${step}`);
      if (!stepElement) return true;

      const inputs = stepElement.querySelectorAll('input[required], select[required]');
      inputs.forEach(input => {
        const err = input.parentElement.querySelector('.error-message');
        if (!input.value || !String(input.value).trim()) {
          input.classList.add('error');
          if (err) err.classList.add('show');
          valid = false;
        } else {
          input.classList.remove('error');
          if (err) err.classList.remove('show');
        }
      });

      if (step === 3) {
        const plan = document.getElementById('paymentPlan').value;
        const location = document.getElementById('location').value;

        if (!location) {
          const locInput = document.getElementById('location');
          locInput.classList.add('error');
          locInput.parentElement.querySelector('.error-message').classList.add('show');
          valid = false;
        }

        if (plan === 'Monthly') {
          const downPayment = document.getElementById('downPayment');
          const monthlyPremium = document.getElementById('monthlyPremium');

          if (!downPayment.value || parseCurrency(downPayment.value) === 0) {
            downPayment.classList.add('error');
            downPayment.parentElement.querySelector('.error-message').classList.add('show');
            valid = false;
          }

          if (!monthlyPremium.value || parseCurrency(monthlyPremium.value) === 0) {
            monthlyPremium.classList.add('error');
            monthlyPremium.parentElement.querySelector('.error-message').classList.add('show');
            valid = false;
          }
        }
      }

      return valid;
    }

    // Clear error on input change
    document.addEventListener('input', function(e) {
      const el = e.target;
      if (el.matches('input, select, textarea')) {
        el.classList.remove('error');
        const err = el.parentElement.querySelector('.error-message');
        if (err) err.classList.remove('show');
      }
    });

    function showToast(message, type) {
      const existingToast = document.querySelector('.toast');
      if (existingToast) existingToast.remove();

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${message}</span>`;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3200);
    }

    function submitForm() {
      if (!validateStep(currentStep)) return;

      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Submitting...';
      submitBtn.disabled = true;

      const formData = {
        ...(selectedLanguage && { preferredLanguage: selectedLanguage }),

        ...(selectedContactId && {
          contactId: selectedContactId,
          existingContactPhone: existingContactPhone
        }),

        contactFirstName: document.getElementById('contactFirstName').value,
        contactLastName: document.getElementById('contactLastName').value,
        contactEmail: document.getElementById('contactEmail').value,
        contactPhone: document.getElementById('contactPhone').value,

        quoteNumber: document.getElementById('quoteNumber').value,
        quoteStatus: document.getElementById('quoteStatus').value,
        lineOfBusiness: document.getElementById('lineOfBusiness').value,
        ezlynxQuoteId: document.getElementById('ezlynxQuoteId').value,
        mainCarrier: document.getElementById('mainCarrier').value,
        effectiveDate: document.getElementById('effectiveDate').value,
        grossPremium: parseCurrency(document.getElementById('grossPremium').value),
        taxesAndFees: parseCurrency(document.getElementById('taxesAndFees').value),
        agencyFees: parseCurrency(document.getElementById('agencyFees').value),
        totalPremium: parseCurrency(document.getElementById('totalPremium').value),
        paymentPlan: document.getElementById('paymentPlan').value,
        downPayment: parseCurrency(document.getElementById('downPayment').value),
        monthlyPremium: parseCurrency(document.getElementById('monthlyPremium').value),
        location: document.getElementById('location').value,
        dateQuoted: document.getElementById('dateQuoted').value,
        expirationDate: document.getElementById('expirationDate').value,
        notes: document.getElementById('notes').value,
        isNewContact: !selectedContactId,
        timestamp: new Date().toISOString()
      };

      console.log('Submitting form data:', formData);

      fetch('https://services.leadconnectorhq.com/hooks/YtNhoKQqqoEZSVFceqZm/webhook-trigger/26db136c-27ca-47b4-af16-f8b1f0dfd852', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      })
      .then(function(response) {
        console.log('Response status:', response.status);
        if (response.ok) {
          showToast('Quote submitted successfully!', 'success');
          setTimeout(function() {
            window.top.location.href = 'https://crm.gogreeninsurance.com/v2/location/YtNhoKQqqoEZSVFceqZm/contacts/smart_list/All';
          }, 2000);
        } else {
          showToast('Error submitting quote. Please try again.', 'error');
        }
      })
      .catch(function(error) {
        console.error('Network Error:', error);
        showToast('Network error. Please try again.', 'error');
      })
      .finally(function() {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      });
    }

    // Backup force show modal (for GHL embeds)
    setTimeout(() => {
      const overlay = document.getElementById('modalOverlay');
      if (overlay && overlay.style.display !== 'flex') {
        overlay.style.display = 'flex';
        document.body.classList.add('green-quote-modal-active');

        const dateQuoted = document.getElementById('dateQuoted');
        const quoteNumber = document.getElementById('quoteNumber');
        if (dateQuoted && !dateQuoted.value) {
          dateQuoted.value = new Date().toISOString().split('T')[0];
        }
        if (quoteNumber && !quoteNumber.value) {
          quoteNumber.value = generateQuoteNumber();
        }
      }
    }, 500);
  </script>
</body>
</html>
